name: Release dbt-spark-submit

# Triggers on every human push to spark-submit.
# 1. Finds the latest "dbt-spark-submit-v*" tag and bumps the patch number.
# 2. Pushes the new tag.
# 3. Creates a GitHub Release from that tag.
# The PyPI publish workflow fires automatically on the release event.

on:
  push:
    branches:
      - spark-submit

jobs:
  release:
    name: Tag and create GitHub Release
    # Skip the bot's own commits (e.g. from other automation) to prevent loops.
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write  # needed to push tags and create the release

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # full history so we can find all existing tags

      - name: Compute next version tag
        id: tag
        run: |
          # Find the highest existing dbt-spark-submit-vX.Y.Z tag
          latest=$(git tag --list 'dbt-spark-submit-v*' \
            | sort -t. -k1,1V -k2,2n -k3,3n \
            | tail -1)

          if [ -z "$latest" ]; then
            # No tag yet â€” start at v1.0.0
            new_tag="dbt-spark-submit-v1.0.0"
          else
            # Strip prefix, bump patch
            version="${latest#dbt-spark-submit-v}"
            IFS='.' read -r major minor patch <<< "$version"
            new_tag="dbt-spark-submit-v${major}.${minor}.$((patch + 1))"
          fi

          echo "latest=${latest:-<none>}"
          echo "new_tag=${new_tag}"
          echo "new_tag=${new_tag}" >> "$GITHUB_OUTPUT"
          echo "version=${new_tag#dbt-spark-submit-v}" >> "$GITHUB_OUTPUT"

      - name: Push new tag
        run: |
          git tag "${{ steps.tag.outputs.new_tag }}"
          git push origin "${{ steps.tag.outputs.new_tag }}"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.tag.outputs.new_tag }}" \
            --target spark-submit \
            --title "dbt-spark-submit v${{ steps.tag.outputs.version }}" \
            --notes "Automated release of dbt-spark-submit v${{ steps.tag.outputs.version }}." \
            --latest
